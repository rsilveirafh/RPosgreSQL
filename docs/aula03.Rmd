---
title: "aula03 :: PostgreSQL + R"
author: "Ricardo da Silveira Filho"
date: "10 abr 2021"
output: html_document
---
	
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

***
### 0) Setup

- Carregando os pacotes a serem utilizados na sessão
```{r, message=FALSE}
library(lubridate)
library(RPostgres)
library(stf)
library(tidyverse)
```

***
### 1) Tidyverse (continuação)

- Construindo Dataframes
```{r}
# Criando data.frame com rbase
df <- data.frame(col1 = c("a", "b", "c"),
				 col2 = c(1, 2, 3))
# Estrutura
str(df)

# Criando data.frame com tibble
df_tibble <- tibble(col1 = c("a", "b", "c"),
				 col2 = c(1, 2, 3))

# Estrutura
glimpse(df_tibble)

# Adicionando linha
df_tibble <- df_tibble %>% 
	add_row(col1 = "d", col2 = 4)

glimpse(df_tibble)

# Adicionando coluna
df_tibble <- df_tibble %>% 
	add_column(col0 = 5:8, .before = 1)

glimpse(df_tibble)

```

***
### 2) dplyr

- Baixando o banco de dados
```{r, eval=FALSE}
# Baixando banco de dados
incid <- 2635061:2635161

stf_download_information(incidente = incid, 
						 dir = here::here("data", "exdplyr", "informacoes"))
stf_download_parties(incid, here::here("data", "exdplyr", "partes"))
stf_download_details(incid, here::here("data", "exdplyr", "detalhes"))
stf_download_sheet(incid, here::here("data", "exdplyr", "movimentacao"))

```

- Colocando em objetos
```{r}
informacoes <- read_stf_information(path = here::here("data", "exdplyr", "informacoes"))
informacoes
partes <- read_stf_parties(path = here::here("data", "exdplyr", "partes"))
partes
detalhes <- read_stf_details(path = here::here("data", "exdplyr", "detalhes"))
detalhes
movimentacao <- read_stf_docket_sheet(path = here::here("data", "exdplyr", "movimentacao"))
movimentacao
```


- `count()`
	- Contabilizando observações
```{r}
detalhes %>% 
	count(relator_atual, sort = TRUE)
```


- `filter()`
	- Filtrando observações (linhas)
```{r}
# Somente um filtro
detalhes %>% 
	filter(classe == "AI")

# Utilizando "OU"
detalhes %>% 
	filter(classe == "AI" | classe == "HC")

# Utilizando "E"
detalhes %>% 
	filter(classe == "HC" & relator_atual == "MIN. CELSO DE MELLO")
```


- `select()`
	- Selecionando colunas
```{r}
# Somente uma variável
informacoes %>% 
	select(incidente)

# Mais de uma variável
informacoes %>% 
	select(incidente, origem)

# Pelo índice
informacoes %>% 
	select(1)

# Três primeiras variáveis
informacoes %>% 
	select(1:3)

informacoes %>% 
	select(incidente:assunto2)

# Retirar variável(is) de um banco de dados
informacoes %>% 
	select(-assunto2)

informacoes %>% 
	select(-c(assunto1, assunto2, assunto3))

# Variáveis que começam com "X"
informacoes %>% 
	select(starts_with("assunto"))

# Variáveis que terminam com "X"
informacoes %>% 
	select(ends_with("origem"))

# Variáveis que contém "X"
informacoes %>% 
	select(contains("origem"))


```


- Tutorial de expressões regulares (regex)
	- <https://direito.consudata.com.br/shiny/stringr/>

```{r}
# Utilizando regex
#	ex.: Selecionando variáveis que tenham números
informacoes %>% 
	select(matches("\\d"))
```


- `arrange()`
	- Ordenando as observações
```{r}
# Ordem alfabética
detalhes %>% 
	arrange(relator_atual)

# Inverter ordem
detalhes %>% 
	arrange(desc(relator_atual))
```


- `mutate()`
	- Criar ou alterar variáveis
```{r}
# Pegando somente o "ano" de uma data
informacoes %>% 
	mutate(ano_protocolo = year(data_protocolo))

# Criando uma variável em um local específico do tibble
informacoes %>% 
	mutate(ano_protocolo = year(data_protocolo), .after = data_protocolo)

# Criando mais de uma variável
informacoes %>% 
	mutate(ano_protocolo = year(data_protocolo),
		   mes_protocolo = month(data_protocolo),
		   dia_protocolo = wday(data_protocolo, label = TRUE, abbr = FALSE),
		   .after = incidente)

# Utilizando `across`
	# ex.: Retirando a palavra "DIREITO" de algumas variáveis
		# AT
informacoes %>% 
	mutate(across(assunto1:assunto3, .fns = ~str_remove(.x, "DIREITO")))

	# ex.: Mudando em TODAS as variáveis
		# ALL
informacoes %>% 
	mutate(across(.fns = as.character))

	# ex.: Mudando SE a variável for "X"
		# IF
informacoes %>% 
	mutate(across(where(is.numeric), .fns = as.character))
```


- `summarize()`
	- Sumarizar os dados
```{r}
df <- tibble(idade = sample(18:50, 30, replace = TRUE))
df

df %>% 
	summarize(media = mean(idade),
			  mediana = median(idade),
			  desvio_padrao = sd(idade),
			  minimo = min(idade),
			  maximo = max(idade))
```


- `group_by()`
	- Agrupando os dados
```{r}
data(starwars)

# Agrupando uma variável
starwars %>% 
	group_by(sex) %>% 
	summarise(peso_sexo = mean(mass, na.rm = TRUE),
			  altura_sexo = mean(height, na.rm = TRUE))

# Agrupando mais de uma variável
starwars %>% 
	group_by(species, gender) %>% 
	summarise(peso_sp_gn = mean(mass, na.rm = TRUE))
```


***
## 3) PosgreSQL + R





















